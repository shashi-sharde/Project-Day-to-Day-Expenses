// <!-- **********************************Adding Expense********************************* -->
function ExpenseDetails(event){
    event.preventDefault(event);
    const MoneySpent = event.target.number.value;
    const Description = event.target.description.value;
    const Categories = event.target.categories.value;
   
    const obj = {
        MoneySpent,
        Description,
        Categories
    }
    const token = localStorage.getItem('token')
    axios.post('http://localhost:3000/users/login/add-expense', obj,{ headers: {"Authorization" : token} })
    .then((response)=>{
        DisplayOnScreen(response.data.newExpenseDetails)
        console.log(response)
    })
    .catch((err)=>{
        console.log(err)
    })
}
//****************************************************Getting Expenses**************************************************//
window.addEventListener("DOMContentLoaded", async(event) => {
    
    const token = localStorage.getItem('token')
    
    
    const decodeToken = parseJwt(token)
    console.log(decodeToken)
    const isPremiumUser = decodeToken.isPremiumUser
    if(isPremiumUser){
        showPremiumuserMessage()
        showLeaderboard();

    }
    if(!isPremiumUser){
        var bt1=document.getElementById('exp-leaderboard')
            bt1.onclick = function (){
            alert('please upgrade to premium to access this feature!')
            }
        var bt2=document.getElementById('AllDownloads')
            bt2.onclick = function (){
            alert('please upgrade to premium to access this feature!')
        }
        var bt3=document.getElementById('downloadExpense')
            bt3.onclick = function (){
            alert('please upgrade to premium to access this feature!')
        }

    }
    await axios.get(`http://localhost:3000/users/login/get-expense/`,{ headers: {"Authorization" : token} })
    .then((response)=>{
        console.log("Expense details",response.data)
        response.data.forEach(data => {
                DisplayOnScreen(data)
            });   
        
    })
    .catch((err)=>{
        console.log(err)
    })
})
function DisplayOnScreen(expense){
    const parentNode = document.getElementById("NumberOfExpenses")
    const childNode = `<li id=${expense.id}>${expense.Categories}: Money Spent - Rs ${expense.MoneySpent}- on ${expense.Description}
    <button onclick=deleteExpense('${expense.id}') align ="inline">X</li>`
    parentNode.innerHTML = parentNode.innerHTML + childNode
}

function deleteExpense(expenseId){
    axios.delete(`http://localhost:3000/users/login/delete-expense/${expenseId}`)
    removeExpenseFromScreen(expenseId);
}
function removeExpenseFromScreen(expenseId){
    const parentNode = document.getElementById('NumberOfExpenses');
    const childNodeToBeDeleted = document.getElementById(expenseId);

    parentNode.removeChild(childNodeToBeDeleted);
}

function showPremiumuserMessage() {
document.getElementById('rzp-button1').style.visibility='hidden'
document.getElementById('message').innerHTML = `<strong>PREMIUM USER </strong>`;
}
function parseJwt (token) {
var base64Url = token.split('.')[1];
var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
}).join(''));

return JSON.parse(jsonPayload);
}

//<!--****************************************Razorpay Integration for Premium User************************************* -->
document.getElementById('rzp-button1').onclick =async function(e){ 
const token =localStorage.getItem('token')

const response= await axios.get('http://localhost:3000/purchase/premiummembership', {headers: {"Authorization" : token }});
console.log(response);

var options = 
{    

"key": response.data.key_id, //Key ID generated from the Dashboard
"order_id": response.data.order.id, // for One time payment 

// this handler only gets called when payment gets successfull
"handler" : async function(response){
    const res = await axios.post('http://localhost:3000/purchase/updateTransactionStatus',{
        order_id: options.order_id,
        payment_id: response.razorpay_payment_id,
    }, {headers : {"Authorization" : token}})
    

    //Sending the messege after successfull payment
    alert('You are a Premium User Now');
    
    // making the buy premium button non visible after successfull payment
    document.getElementById('rzp-button1').style.visibility='hidden'

    //Showing user that he/she is a premium USer
    document.getElementById('message').innerHTML = `<strong>PREMIUM USER </strong>`;
    localStorage.setItem('token', res.data.token)
    //Also setting the token after that 
    //localStorage.setItem('token', res.data.token)
    showLeaderboard();

},
};

//once click on the event for opeing the razorpay window
const rzp1 = new Razorpay(options);
rzp1.open();
e.preventDefault();
//Sending the 
rzp1.on('payment.failed', function(response){
console.log(response)

const res = axios.post('http://localhost:3000/purchase/updateTransactionStatus',{
        order_id: options.order_id,
        payment_id: response.razorpay_payment_id,
    }, {headers : {"Authorization" : token}})
alert("Something went Wrong!")

});
}

// ************************************leaderBoard Details***************************************************************
function showLeaderboard(){
document.getElementById('exp-leaderboard').onclick= async () => {
const token =localStorage.getItem('token')
const response = await axios.get('http://localhost:3000/premium/Show_leaderBoard' , {headers: {"Authorization" : token }})
console.log(response);

var leaderboardParentElement = document.getElementById('leaderboard');
leaderboardParentElement.innerHTML = `<h1> Leader Board </h1>`
response.data.forEach((userDetails) => {
leaderboardDisplay(userDetails)

})
}
function leaderboardDisplay(userDetails){
var leaderboardParentElement = document.getElementById('leaderboard');
childNode= `<l1 id= ${userDetails.id}> Name- ${userDetails.username} Total Expense- ${userDetails.TotalCost || 0} </li><br>`
leaderboardParentElement.innerHTML =  leaderboardParentElement.innerHTML+ childNode
}


}
//***************************************************Downloading the Expenses as file********************************************
function download(){
const token =localStorage.getItem('token')
axios.get('http://localhost:3000/user/download', {headers :{"Authorization": token}})
.then((response)=>{
if(response.status === 201){
    var a = document.createElement('a')
    a.href= response.data.fileURl;
    a.download = "MyExpense.csv"
    a.click();
}if(response.status===207){
alert('please upgrade to premium to access this feature!')
Â }
}).catch(err =>{
console.log(err)
})


}
// ***************************************************Download History **************************************************//
function download_List(){
const token =localStorage.getItem('token')
var DownloadlistParentElement = document.getElementById('downloadedURL');
axios.get('http://localhost:3000/user/getAllUrl', {headers :{"Authorization": token}})
.then((response)=>{
if(response.status === 200){
    console.log(response);
    
    DownloadlistParentElement.innerHTML = `<h1> Downloaded List </h1>`
    for(i=0;i<response.data.data.length;i++){
        DownloadListDisplay(response.data.data[i])
    
    
    
}
}
function DownloadListDisplay(downloadurl){
var DownloadlistParentElement = document.getElementById('downloadedURL');
childNode= `<l1 id= ${downloadurl.id}>  Id :- ${downloadurl.id} <br> FileName :- ${downloadurl.filename}  <br>
    <a href=${downloadurl.fileurl}>Click To Download File</a> </li><br>`
    DownloadlistParentElement.innerHTML =  DownloadlistParentElement.innerHTML+ childNode
}
}).catch(err =>{
console.log(err)
})

}




